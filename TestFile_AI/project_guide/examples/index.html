<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BookReview - 나만의 북 리뷰</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>📚 BookReview</h1>
            <nav>
                <a href="index.html" class="active">홈</a>
                <a href="book_add.html">책 추가</a>
                <div class="user-menu">
                    <span id="userGreeting" style="display: none;"></span>
                    <a href="login.html" id="loginBtn">로그인</a>
                    <a href="register.html" id="registerBtn">회원가입</a>
                    <a href="#" id="logoutBtn" style="display: none;">로그아웃</a>
                </div>
            </nav>
        </header>
        
        <main>
            <section class="hero">
                <h2>📖 나만의 독서 기록을 시작해보세요</h2>
                <p>읽은 책의 감상을 기록하고 다른 사람들의 리뷰도 확인해보세요!</p>
            </section>
            
            <section class="search-section">
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="책 제목이나 저자로 검색...">
                    <button id="searchBtn">🔍 검색</button>
                </div>
            </section>
            
            <section id="book-list">
                <h2>📚 등록된 책들</h2>
                <div id="books-container">
                    <!-- JavaScript로 책 목록이 여기에 추가됩니다 -->
                </div>
            </section>
            
            <section id="recent-reviews">
                <h2>⭐ 최신 리뷰</h2>
                <div id="reviews-container">
                    <!-- JavaScript로 리뷰 목록이 여기에 추가됩니다 -->
                </div>
            </section>
        </main>
        
        <footer>
            <p>&copy; 2025 BookReview. Made with ❤️ by Team BookReview</p>
        </footer>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            initMainPage();
            updateUserMenu();
            setupSearch();
        });
        
        function initMainPage() {
            initSampleData(); // 샘플 데이터 초기화
            displayBooks();
            displayRecentReviews();
        }
        
        function updateUserMenu() {
            const currentUser = getCurrentUser();
            const userGreeting = document.getElementById('userGreeting');
            const loginBtn = document.getElementById('loginBtn');
            const registerBtn = document.getElementById('registerBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            
            if (currentUser) {
                userGreeting.textContent = `안녕하세요, ${currentUser.name}님! 👋`;
                userGreeting.style.display = 'inline';
                loginBtn.style.display = 'none';
                registerBtn.style.display = 'none';
                logoutBtn.style.display = 'inline';
            } else {
                userGreeting.style.display = 'none';
                loginBtn.style.display = 'inline';
                registerBtn.style.display = 'inline';
                logoutBtn.style.display = 'none';
            }
        }
        
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            
            searchBtn.addEventListener('click', performSearch);
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
        }
        
        function performSearch() {
            const keyword = document.getElementById('searchInput').value.trim();
            const books = searchBooks(keyword);
            displayBooks(books);
        }
        
        function displayBooks(books = null) {
            if (!books) books = getBooks();
            
            const container = document.getElementById('books-container');
            
            if (books.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>📝 등록된 책이 없습니다.</p>
                        <p>첫 번째 책을 <a href="book_add.html">추가</a>해보세요!</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            books.forEach(book => {
                const reviews = getReviewsByBook(book.id);
                const avgRating = reviews.length > 0 ? 
                    (reviews.reduce((sum, r) => sum + r.rating, 0) / reviews.length).toFixed(1) : 0;
                
                html += `
                    <div class="book-card">
                        <div class="book-info">
                            <h3>${book.title}</h3>
                            <p class="author">👤 ${book.author}</p>
                            <p class="publisher">🏢 ${book.publisher}</p>
                            <p class="genre">🏷️ ${book.genre}</p>
                            <div class="rating">
                                <span>${getStarRating(Math.round(avgRating))}</span>
                                <span class="rating-text">${avgRating}/5 (${reviews.length}개 리뷰)</span>
                            </div>
                        </div>
                        <div class="book-actions">
                            <button onclick="viewBook(${book.id})" class="btn-primary">📖 상세보기</button>
                            <button onclick="writeReview(${book.id})" class="btn-secondary">⭐ 리뷰 쓰기</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function displayRecentReviews() {
            const reviews = getRecentReviews(3);
            const container = document.getElementById('reviews-container');
            
            if (reviews.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>📝 아직 작성된 리뷰가 없습니다.</p>
                        <p>첫 번째 리뷰를 작성해보세요!</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            reviews.forEach(review => {
                const book = getBookById(review.bookId);
                html += `
                    <div class="review-card">
                        <div class="review-header">
                            <h4>📖 ${book ? book.title : '알 수 없는 책'}</h4>
                            <div class="rating">${getStarRating(review.rating)}</div>
                        </div>
                        <div class="review-content">
                            <p>"${review.content}"</p>
                        </div>
                        <div class="review-footer">
                            <span class="reviewer">👤 ${review.userName}</span>
                            <span class="review-date">📅 ${formatDate(review.reviewDate)}</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function viewBook(bookId) {
            // 책 상세 페이지로 이동 (실제로는 별도 페이지나 모달로 구현)
            const book = getBookById(bookId);
            const reviews = getReviewsByBook(bookId);
            
            let reviewsHtml = '';
            reviews.forEach(review => {
                reviewsHtml += `
                    <div class="review-item">
                        <div>${getStarRating(review.rating)} - ${review.userName}</div>
                        <div>"${review.content}"</div>
                        <div class="review-date">${formatDate(review.reviewDate)}</div>
                    </div>
                `;
            });
            
            const modalHtml = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <button class="modal-close" onclick="closeModal()">×</button>
                        <h2>${book.title}</h2>
                        <p><strong>저자:</strong> ${book.author}</p>
                        <p><strong>출판사:</strong> ${book.publisher}</p>
                        <p><strong>장르:</strong> ${book.genre}</p>
                        <p><strong>설명:</strong> ${book.description}</p>
                        <h3>리뷰 (${reviews.length}개)</h3>
                        <div class="reviews-list">${reviewsHtml || '아직 리뷰가 없습니다.'}</div>
                        <button onclick="writeReview(${bookId})" class="btn-primary">리뷰 작성하기</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function writeReview(bookId) {
            const currentUser = getCurrentUser();
            if (!currentUser) {
                alert('리뷰를 작성하려면 로그인이 필요합니다.');
                window.location.href = 'login.html';
                return;
            }
            
            const book = getBookById(bookId);
            const rating = prompt(`"${book.title}"에 대한 평점을 입력하세요 (1-5):`);
            if (!rating || rating < 1 || rating > 5) {
                alert('올바른 평점(1-5)을 입력해주세요.');
                return;
            }
            
            const content = prompt('리뷰 내용을 입력하세요:');
            if (!content || content.trim() === '') {
                alert('리뷰 내용을 입력해주세요.');
                return;
            }
            
            const newReview = addReview(bookId, rating, content.trim());
            if (newReview) {
                alert('리뷰가 작성되었습니다!');
                displayBooks(); // 평점 업데이트 반영
                displayRecentReviews();
                closeModal();
            } else {
                alert('리뷰 작성 중 오류가 발생했습니다.');
            }
        }
        
        function closeModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }
        
        // 로그아웃 버튼 이벤트
        document.getElementById('logoutBtn').addEventListener('click', function(e) {
            e.preventDefault();
            logoutUser();
            updateUserMenu();
            alert('로그아웃되었습니다.');
        });
    </script>
</body>
</html>