// ===== BookReview ÎÇ¥ Î¶¨Î∑∞ ÌéòÏù¥ÏßÄ - Í∞ÄÏù¥Îìú Í∏∞Î∞ò =====

// Ï†ÑÏó≠ Î≥ÄÏàò
let currentUser = null;
let userReviews = [];
let userStats = {};

// DOM ÏöîÏÜå Ï∞∏Ï°∞
const elements = {
    // Í∞ÄÏù¥Îìú ÌÜ†Í∏Ä
    guideToggleBtn: document.getElementById('guideToggleBtn'),
    guideComments: document.querySelectorAll('.guide-comment'),
    
    // ÏÇ¨Ïö©Ïûê Í¥ÄÎ†®
    userGreeting: document.getElementById('userGreeting'),
    loginBtn: document.getElementById('loginBtn'),
    registerBtn: document.getElementById('registerBtn'),
    logoutBtn: document.getElementById('logoutBtn'),
    
    // ÏÑπÏÖòÎì§
    loginRequiredSection: document.getElementById('loginRequiredSection'),
    userStatsSection: document.getElementById('userStatsSection'),
    reviewsManagementSection: document.getElementById('reviewsManagementSection'),
    
    // ÌÜµÍ≥Ñ ÌëúÏãú
    totalUserReviews: document.getElementById('totalUserReviews'),
    avgUserRating: document.getElementById('avgUserRating'),
    recommendedCount: document.getElementById('recommendedCount'),
    favoriteGenre: document.getElementById('favoriteGenre'),
    
    // Î¶¨Î∑∞ Í¥ÄÎ¶¨
    reviewSortBy: document.getElementById('reviewSortBy'),
    writeNewReviewBtn: document.getElementById('writeNewReviewBtn'),
    reviewsLoading: document.getElementById('reviewsLoading'),
    myReviewsList: document.getElementById('myReviewsList'),
    
    // Î™®Îã¨
    editReviewModal: document.getElementById('editReviewModal'),
    closeEditReviewModal: document.getElementById('closeEditReviewModal'),
    editReviewForm: document.getElementById('editReviewForm'),
    cancelEditReview: document.getElementById('cancelEditReview'),
    editReviewId: document.getElementById('editReviewId'),
    editBookInfo: document.getElementById('editBookInfo'),
    editStarRating: document.getElementById('editStarRating'),
    editRating: document.getElementById('editRating'),
    editContent: document.getElementById('editContent'),
    editIsRecommended: document.getElementById('editIsRecommended')
};

// ===== ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî =====

document.addEventListener('DOMContentLoaded', function() {
    // Í∞ÄÏù¥Îìú ÌÜ†Í∏Ä ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî
    initGuideToggleSystem();
    
    // ÏÇ¨Ïö©Ïûê Ïù∏Ï¶ù ÏÉÅÌÉú ÌôïÏù∏
    checkUserAuthentication();
    
    // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
    setupEventListeners();
    
    // Îç∞Ïù¥ÌÑ∞ Î°úÎìú
    if (currentUser) {
        loadUserData();
    }
});

// ===== Í∞ÄÏù¥Îìú ÌÜ†Í∏Ä ÏãúÏä§ÌÖú =====

function initGuideToggleSystem() {
    let guideCommentsVisible = false;

    if (elements.guideToggleBtn) {
        elements.guideToggleBtn.addEventListener('click', function() {
            guideCommentsVisible = !guideCommentsVisible;
            
            if (guideCommentsVisible) {
                elements.guideComments.forEach(comment => {
                    comment.classList.add('show');
                });
                
                elements.guideToggleBtn.classList.add('active');
                elements.guideToggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Í∞ÄÏù¥Îìú ÏÑ§Î™Ö Ïà®Í∏∞Í∏∞';
                showNotification('Í∞ÄÏù¥Îìú ÌôúÏö© ÏÑ§Î™ÖÏù¥ ÌëúÏãúÎêòÏóàÏäµÎãàÎã§! üìö', 'success');
                
            } else {
                elements.guideComments.forEach(comment => {
                    comment.classList.remove('show');
                });
                
                elements.guideToggleBtn.classList.remove('active');
                elements.guideToggleBtn.innerHTML = '<i class="fas fa-info-circle"></i> Í∞ÄÏù¥Îìú ÌôúÏö© ÏÑ§Î™Ö Î≥¥Í∏∞';
                showNotification('Í∞ÄÏù¥Îìú ÏÑ§Î™ÖÏù¥ Ïà®Í≤®Ï°åÏäµÎãàÎã§.', 'info');
            }
        });
    }
}

// ===== ÏÇ¨Ïö©Ïûê Ïù∏Ï¶ù ÌôïÏù∏ =====

function checkUserAuthentication() {
    currentUser = getCurrentUser();
    
    if (currentUser) {
        // Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú
        showLoggedInSections();
        updateUserInterface();
    } else {
        // ÎπÑÎ°úÍ∑∏Ïù∏ ÏÉÅÌÉú
        showLoginRequiredSection();
    }
}

function showLoginRequiredSection() {
    if (elements.loginRequiredSection) {
        elements.loginRequiredSection.style.display = 'block';
    }
    if (elements.userStatsSection) {
        elements.userStatsSection.style.display = 'none';
    }
    if (elements.reviewsManagementSection) {
        elements.reviewsManagementSection.style.display = 'none';
    }
}

function showLoggedInSections() {
    if (elements.loginRequiredSection) {
        elements.loginRequiredSection.style.display = 'none';
    }
    if (elements.userStatsSection) {
        elements.userStatsSection.style.display = 'block';
    }
    if (elements.reviewsManagementSection) {
        elements.reviewsManagementSection.style.display = 'block';
    }
}

function updateUserInterface() {
    if (currentUser) {
        if (elements.userGreeting) {
            elements.userGreeting.textContent = `${currentUser.username}Îãò`;
            elements.userGreeting.style.display = 'inline-block';
        }
        
        if (elements.loginBtn) elements.loginBtn.style.display = 'none';
        if (elements.registerBtn) elements.registerBtn.style.display = 'none';
        if (elements.logoutBtn) elements.logoutBtn.style.display = 'inline-block';
    }
}

// ===== Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï =====

function setupEventListeners() {
    // Î°úÍ∑∏ÏïÑÏõÉ
    if (elements.logoutBtn) {
        elements.logoutBtn.addEventListener('click', handleLogout);
    }
    
    // Ï†ïÎ†¨
    if (elements.reviewSortBy) {
        elements.reviewSortBy.addEventListener('change', handleSortChange);
    }
    
    // ÏÉà Î¶¨Î∑∞ ÏûëÏÑ±
    if (elements.writeNewReviewBtn) {
        elements.writeNewReviewBtn.addEventListener('click', function() {
            window.location.href = 'books.html';
        });
    }
    
    // Î¶¨Î∑∞ ÏàòÏ†ï Î™®Îã¨
    if (elements.closeEditReviewModal) {
        elements.closeEditReviewModal.addEventListener('click', closeEditReviewModal);
    }
    
    if (elements.cancelEditReview) {
        elements.cancelEditReview.addEventListener('click', closeEditReviewModal);
    }
    
    if (elements.editReviewModal) {
        elements.editReviewModal.addEventListener('click', function(e) {
            if (e.target === elements.editReviewModal) {
                closeEditReviewModal();
            }
        });
    }
    
    if (elements.editReviewForm) {
        elements.editReviewForm.addEventListener('submit', handleEditReview);
    }
    
    // Î≥ÑÏ†ê ÏûÖÎ†•
    if (elements.editStarRating) {
        setupStarRating();
    }
}

// ===== Îç∞Ïù¥ÌÑ∞ Î°úÎìú - Í∞ÄÏù¥Îìú "ÏÇ¨Ïö©ÏûêÎ≥Ñ Îç∞Ïù¥ÌÑ∞" ÌôúÏö© =====

function loadUserData() {
    showLoading();
    
    // Í∞ÄÏù¥Îìú data.jsÏùò getReviewsByUser() Ìï®Ïàò ÌôúÏö©
    userReviews = getReviewsByUser(currentUser.id);
    
    // Í∞ÄÏù¥Îìú data.jsÏùò getUserStats() Ìï®Ïàò ÌôúÏö©
    userStats = getUserStats(currentUser.id);
    
    setTimeout(() => {
        hideLoading();
        updateUserStats();
        renderUserReviews();
    }, 500);
}

function showLoading() {
    if (elements.reviewsLoading) {
        elements.reviewsLoading.style.display = 'block';
    }
    if (elements.myReviewsList) {
        elements.myReviewsList.style.display = 'none';
    }
}

function hideLoading() {
    if (elements.reviewsLoading) {
        elements.reviewsLoading.style.display = 'none';
    }
    if (elements.myReviewsList) {
        elements.myReviewsList.style.display = 'block';
    }
}

// ===== ÏÇ¨Ïö©Ïûê ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏ - Í∞ÄÏù¥Îìú "ÌÜµÍ≥Ñ Í≥ÑÏÇ∞" ÌôúÏö© =====

function updateUserStats() {
    if (!userStats) return;
    
    // Ï¥ù Î¶¨Î∑∞ Ïàò
    if (elements.totalUserReviews) {
        elements.totalUserReviews.textContent = userStats.totalReviews.toLocaleString();
    }
    
    // ÌèâÍ∑† ÌèâÏ†ê
    if (elements.avgUserRating) {
        elements.avgUserRating.textContent = userStats.averageRating.toFixed(1);
    }
    
    // Ï∂îÏ≤úÌïú Ï±Ö Ïàò
    if (elements.recommendedCount) {
        elements.recommendedCount.textContent = userStats.recommendedBooks.toLocaleString();
    }
    
    // ÏÑ†Ìò∏ Ïû•Î•¥
    if (elements.favoriteGenre) {
        if (userStats.favoriteGenres && userStats.favoriteGenres.length > 0) {
            elements.favoriteGenre.textContent = userStats.favoriteGenres[0].genre;
        } else {
            elements.favoriteGenre.textContent = '-';
        }
    }
}

// ===== Î¶¨Î∑∞ Î†åÎçîÎßÅ =====

function renderUserReviews() {
    if (!elements.myReviewsList) return;
    
    if (userReviews.length === 0) {
        showEmptyReviewsState();
        return;
    }
    
    // Ï†ïÎ†¨ Ï†ÅÏö©
    const sortBy = elements.reviewSortBy?.value || 'newest';
    const sortedReviews = sortUserReviews(userReviews, sortBy);
    
    elements.myReviewsList.innerHTML = sortedReviews.map(review => {
        const book = getBookById(review.bookId);
        if (!book) return ''; // ÏÇ≠Ï†úÎêú Ï±ÖÏùò Í≤ΩÏö∞
        
        return `
            <div class="my-review-item">
                <div class="review-item-header">
                    <div class="review-book-info">
                        <div class="review-book-title">${escapeHtml(book.title)}</div>
                        <div class="review-book-author">Ï†ÄÏûê: ${escapeHtml(book.author)}</div>
                        <div class="review-book-meta">
                            ${book.publisher ? `<span><i class="fas fa-building"></i> ${escapeHtml(book.publisher)}</span>` : ''}
                            ${book.genre ? `<span><i class="fas fa-tag"></i> ${escapeHtml(book.genre)}</span>` : ''}
                        </div>
                    </div>
                    <div class="review-actions">
                        <button class="review-action-btn edit-review-btn" onclick="openEditReviewModal('${review.id}')">
                            <i class="fas fa-edit"></i> ÏàòÏ†ï
                        </button>
                        <button class="review-action-btn delete-review-btn" onclick="deleteReviewConfirm('${review.id}')">
                            <i class="fas fa-trash"></i> ÏÇ≠Ï†ú
                        </button>
                    </div>
                </div>
                
                <div class="review-item-rating">
                    <div class="review-rating-stars">
                        ${generateStars(review.rating)}
                    </div>
                    <div class="review-rating-text">
                        ${review.rating}Ï†ê
                    </div>
                </div>
                
                <div class="review-item-content">
                    ${escapeHtml(review.content)}
                </div>
                
                <div class="review-item-footer">
                    <div class="review-date">
                        <i class="fas fa-calendar"></i>
                        ${formatDate(review.reviewDate)}
                    </div>
                    <div class="${review.isRecommended ? 'review-recommended' : 'review-not-recommended'}">
                        <i class="fas fa-${review.isRecommended ? 'thumbs-up' : 'thumbs-down'}"></i>
                        ${review.isRecommended ? 'Ï∂îÏ≤ú' : 'ÎπÑÏ∂îÏ≤ú'}
                    </div>
                </div>
            </div>
        `;
    }).filter(html => html).join('');
}

function showEmptyReviewsState() {
    elements.myReviewsList.innerHTML = `
        <div class="empty-reviews">
            <i class="fas fa-star"></i>
            <h3>ÏûëÏÑ±Ìïú Î¶¨Î∑∞Í∞Ä ÏóÜÏäµÎãàÎã§</h3>
            <p>Ï¢ãÏïÑÌïòÎäî Ï±ÖÏóê ÎåÄÌïú Ï≤´ Î≤àÏß∏ Î¶¨Î∑∞Î•º ÏûëÏÑ±Ìï¥Î≥¥ÏÑ∏Ïöî!</p>
            <button class="btn-primary" onclick="window.location.href='books.html'">
                <i class="fas fa-plus"></i> Î¶¨Î∑∞ ÏûëÏÑ±ÌïòÎü¨ Í∞ÄÍ∏∞
            </button>
        </div>
    `;
}

// ===== Ï†ïÎ†¨ Ìï®Ïàò =====

function sortUserReviews(reviews, sortBy) {
    return reviews.sort((a, b) => {
        switch (sortBy) {
            case 'newest':
                return new Date(b.reviewDate) - new Date(a.reviewDate);
            case 'oldest':
                return new Date(a.reviewDate) - new Date(b.reviewDate);
            case 'rating-high':
                return b.rating - a.rating;
            case 'rating-low':
                return a.rating - b.rating;
            default:
                return 0;
        }
    });
}

function handleSortChange() {
    renderUserReviews();
}

// ===== Î¶¨Î∑∞ ÏàòÏ†ï Î™®Îã¨ =====

function openEditReviewModal(reviewId) {
    const review = userReviews.find(r => r.id === reviewId);
    const book = getBookById(review.bookId);
    
    if (!review || !book) return;
    
    // Î™®Îã¨ ÌïÑÎìú Ï±ÑÏö∞Í∏∞
    if (elements.editReviewId) {
        elements.editReviewId.value = reviewId;
    }
    
    if (elements.editBookInfo) {
        elements.editBookInfo.innerHTML = `
            <h4>${escapeHtml(book.title)}</h4>
            <p>Ï†ÄÏûê: ${escapeHtml(book.author)}</p>
        `;
    }
    
    // Î≥ÑÏ†ê ÏÑ§Ï†ï
    setStarRating(review.rating);
    
    if (elements.editContent) {
        elements.editContent.value = review.content;
    }
    
    if (elements.editIsRecommended) {
        elements.editIsRecommended.checked = review.isRecommended;
    }
    
    // Î™®Îã¨ ÌëúÏãú
    if (elements.editReviewModal) {
        elements.editReviewModal.classList.add('active');
        
        setTimeout(() => {
            if (elements.editContent) {
                elements.editContent.focus();
            }
        }, 100);
    }
}

function closeEditReviewModal() {
    if (elements.editReviewModal) {
        elements.editReviewModal.classList.remove('active');
    }
    
    if (elements.editReviewForm) {
        elements.editReviewForm.reset();
    }
    
    // Î≥ÑÏ†ê Î¶¨ÏÖã
    resetStarRating();
}

// ===== Î≥ÑÏ†ê ÏûÖÎ†• ÏãúÏä§ÌÖú =====

function setupStarRating() {
    const stars = elements.editStarRating.querySelectorAll('.star');
    
    stars.forEach((star, index) => {
        star.addEventListener('click', function() {
            const rating = parseInt(this.dataset.rating);
            setStarRating(rating);
        });
        
        star.addEventListener('mouseenter', function() {
            highlightStars(parseInt(this.dataset.rating));
        });
    });
    
    elements.editStarRating.addEventListener('mouseleave', function() {
        const currentRating = parseInt(elements.editRating.value) || 0;
        highlightStars(currentRating);
    });
}

function setStarRating(rating) {
    if (elements.editRating) {
        elements.editRating.value = rating;
    }
    highlightStars(rating);
}

function highlightStars(rating) {
    const stars = elements.editStarRating.querySelectorAll('.star');
    
    stars.forEach((star, index) => {
        const starRating = parseInt(star.dataset.rating);
        const icon = star.querySelector('i');
        
        if (starRating <= rating) {
            star.classList.add('active');
            icon.className = 'fas fa-star';
        } else {
            star.classList.remove('active');
            icon.className = 'far fa-star';
        }
    });
}

function resetStarRating() {
    if (elements.editRating) {
        elements.editRating.value = '';
    }
    highlightStars(0);
}

// ===== Î¶¨Î∑∞ ÏàòÏ†ï/ÏÇ≠Ï†ú =====

function handleEditReview(e) {
    e.preventDefault();
    
    const reviewId = elements.editReviewId.value;
    const rating = parseInt(elements.editRating.value);
    const content = elements.editContent.value.trim();
    const isRecommended = elements.editIsRecommended.checked;
    
    // Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
    if (!rating || rating < 1 || rating > 5) {
        showNotification('ÌèâÏ†êÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
        return;
    }
    
    if (!content) {
        showNotification('Î¶¨Î∑∞ ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
        return;
    }
    
    // Î¶¨Î∑∞ ÏóÖÎç∞Ïù¥Ìä∏ - Í∞ÄÏù¥Îìú data.jsÏùò updateReview() Ìï®Ïàò ÌôúÏö©
    const updatedReview = updateReview(reviewId, {
        rating: rating,
        content: content,
        isRecommended: isRecommended
    });
    
    if (updatedReview) {
        showNotification('Î¶¨Î∑∞Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§!', 'success');
        closeEditReviewModal();
        loadUserData(); // Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®
    } else {
        showNotification('Î¶¨Î∑∞ ÏàòÏ†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
    }
}

function deleteReviewConfirm(reviewId) {
    const review = userReviews.find(r => r.id === reviewId);
    const book = getBookById(review.bookId);
    
    if (!review || !book) return;
    
    if (confirm(`"${book.title}"Ïóê ÎåÄÌïú Î¶¨Î∑∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.`)) {
        // Í∞ÄÏù¥Îìú data.jsÏùò deleteReview() Ìï®Ïàò ÌôúÏö©
        const success = deleteReview(reviewId);
        
        if (success) {
            showNotification('Î¶¨Î∑∞Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', 'success');
            loadUserData(); // Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®
        } else {
            showNotification('Î¶¨Î∑∞ ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
        }
    }
}

// ===== Í∏∞ÌÉÄ Í∏∞Îä• =====

function handleLogout() {
    if (confirm('Î°úÍ∑∏ÏïÑÏõÉ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
        logoutUser();
        showNotification('Î°úÍ∑∏ÏïÑÏõÉ ÎêòÏóàÏäµÎãàÎã§.', 'info');
        
        setTimeout(() => {
            window.location.href = 'index.html';
        }, 1000);
    }
}

function showNotification(message, type = 'info') {
    const existingNotification = document.querySelector('.notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => notification.classList.add('show'), 100);
    
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}